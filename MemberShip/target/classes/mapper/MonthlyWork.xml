<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
  <mapper namespace="MonthlyWork">
  	
  	<select id="monthlySum" parameterType="MonthlyWork" resultType="MonthlyWork">
  		SELECT DISTINCT
        (select COUNT(*) from m_work WHERE 1=1 AND TO_CHAR(M_MONTH,'MM') = #{m_month}) AS total,
        (SELECT COUNT(*) FROM M_WORK WHERE 1=1 AND TO_CHAR(M_MONTH,'MM') = #{m_month} AND j_except = 'N') AS except,
        (SELECT COUNT(*) FROM M_WORK WHERE 1=1 AND TO_CHAR(M_MONTH,'MM') = #{m_month} AND j_except = 'Y') AS usingWork,
        (SELECT COUNT(*) FROM M_WORK WHERE 1=1 AND TO_CHAR(M_MONTH,'MM') = #{m_month} AND j_except = 'Y' AND j_name != 'SI 사업 발주 대기') AS inputWork1,
        (SELECT COUNT(*) FROM M_WORK WHERE 1=1 AND TO_CHAR(M_MONTH,'MM') = #{m_month} AND j_except = 'Y' AND j_name = 'SI 사업 발주 대기') AS waitWork,
        ROUND(((SELECT COUNT(*) FROM M_WORK WHERE 1=1 AND TO_CHAR(M_MONTH,'MM') = '01' AND j_except = 'Y' AND j_name != 'SI 사업 발주 대기')/(SELECT COUNT(*) FROM M_WORK WHERE 1=1 AND TO_CHAR(M_MONTH,'MM') = '01' AND j_except = 'Y')*100),1) AS AVG1
        FROM m_work
        WHERE TO_CHAR(M_MONTH,'MM') = #{m_month}
  	</select>
  	
  	<select id="monthlyList" parameterType="MonthlyWork" resultType="MonthlyWork">
  		SELECT b.m_id,
  			   b.m_gubun,
  			   b.m_name,
  			   b.m_position,
	           a.j_name,
	           c.l_name,
	           (SELECT A.m_status	FROM M_WORK A WHERE 1=1 AND A.M_ID = b.m_id  and to_char(a.m_year,'yyyy') = #{m_year} and to_char(a.m_month,'MM') = '01') AS JAN,
	           (SELECT a.m_status	FROM M_WORK A WHERE 1=1 AND A.M_ID = b.m_id  and to_char(a.m_year,'yyyy') = #{m_year} and to_char(a.m_month,'MM') = '02') as FEB,
	           (SELECT a.m_status	FROM M_WORK A WHERE 1=1 AND A.M_ID = b.m_id  and to_char(a.m_year,'yyyy') = #{m_year} and to_char(a.m_month,'MM') = '03') as MAR,
	           (SELECT a.m_status	FROM M_WORK A WHERE 1=1 AND A.M_ID = b.m_id  and to_char(a.m_year,'yyyy') = #{m_year} and to_char(a.m_month,'MM') = '04') as APR,
	           (SELECT a.m_status	FROM M_WORK A WHERE 1=1 AND A.M_ID = b.m_id  and to_char(a.m_year,'yyyy') = #{m_year} and to_char(a.m_month,'MM') = '05') as MAY,
	           (SELECT a.m_status	FROM M_WORK A WHERE 1=1 AND A.M_ID = b.m_id  and to_char(a.m_year,'yyyy') = #{m_year} and to_char(a.m_month,'MM') = '06') as JUN,
	           (SELECT a.m_status	FROM M_WORK A WHERE 1=1 AND A.M_ID = b.m_id  and to_char(a.m_year,'yyyy') = #{m_year} and to_char(a.m_month,'MM') = '07') as JUL,
	           (SELECT a.m_status	FROM M_WORK A WHERE 1=1 AND A.M_ID = b.m_id  and to_char(a.m_year,'yyyy') = #{m_year} and to_char(a.m_month,'MM') = '08') as AUG,
	           (SELECT a.m_status	FROM M_WORK A WHERE 1=1 AND A.M_ID = b.m_id  and to_char(a.m_year,'yyyy') = #{m_year} and to_char(a.m_month,'MM') = '09') as SEPT,
	           (SELECT a.m_status	FROM M_WORK A WHERE 1=1 AND A.M_ID = b.m_id  and to_char(a.m_year,'yyyy') = #{m_year} and to_char(a.m_month,'MM') = '10') as OCT,
	           (SELECT a.m_status	FROM M_WORK A WHERE 1=1 AND A.M_ID = b.m_id  and to_char(a.m_year,'yyyy') = #{m_year} and to_char(a.m_month,'MM') = '11') as NOV,
	           (SELECT a.m_status	FROM M_WORK A WHERE 1=1 AND A.M_ID = b.m_id  and to_char(a.m_year,'yyyy') = #{m_year} and to_char(a.m_month,'MM') = '12') as DEC,
	           a.m_notice
  		FROM M_WORK A, member B, site c
        WHERE 1=1
        AND A.M_ID = b.m_id
        AND A.L_CODE = c.L_CODE
        and to_char(a.m_year,'yyyy') = #{m_year}
        and to_char(a.m_month,'MM') = #{m_month}
        <if test="m_gubun != null"> and B.M_GUBUN = #{m_gubun}</if>
        <if test="m_name != null">and B.M_NAME like '%||#{m_name}||%'</if>
        <if test="m_position != null">AND B.M_POSITION = #{m_position}</if>
        <if test="j_name != null">AND A.J_NAME = #{j_name}</if>
  	</select>
  	
  	<select id="monthlyDetail" parameterType="MonthlyWork" resultType="MonthlyWork">
  		select a.m_gubun,
             a.d_code,
             a.m_name,
             a.m_position,
             a.m_notice,
             b.m_month,
             b.j_name,
             b.j_except,
             b.m_notice
	      from MEMBER A, M_WORK B
	      where 1=1
	      and a.m_id=b.m_id
	      and a.m_name = #{m_name}
	      and to_char(b.m_year,'yyyy') = to_char(sysdate,'yyyy')
	      and to_char(b.m_month,'MM') > (TO_CHAR(SYSDATE,'MM')-12)
	      order by b.m_year,b.m_month
  	</select>
  </mapper>