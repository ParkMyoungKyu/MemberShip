<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
  <mapper namespace="MonthlyWork">
  	
  	<select id="monthlySum" parameterType="MonthlyWork" resultType="MonthlyWork">
  		SELECT DISTINCT
        (select COUNT(*) from M_WORK WHERE 1=1 AND TO_CHAR(MW_MONTH,'MM') = LPAD(#{mw_month},2,'0')) AS total,
        (SELECT COUNT(*) FROM M_WORK WHERE 1=1 AND TO_CHAR(MW_MONTH,'MM') = LPAD(#{mw_month},2,'0') AND w_except = 'N') AS except,
        (SELECT COUNT(*) FROM M_WORK WHERE 1=1 AND TO_CHAR(MW_MONTH,'MM') = LPAD(#{mw_month},2,'0') AND w_except = 'Y') AS usingWork,
        (SELECT COUNT(*) FROM M_WORK WHERE 1=1 AND TO_CHAR(MW_MONTH,'MM') = LPAD(#{mw_month},2,'0') AND w_except = 'Y' AND w_name != 'SI 사업 발주 대기') AS inputWork1,
        (SELECT COUNT(*) FROM M_WORK WHERE 1=1 AND TO_CHAR(MW_MONTH,'MM') = LPAD(#{mw_month},2,'0') AND w_except = 'Y' AND w_name = 'SI 사업 발주 대기') AS waitWork,
        ROUND(((SELECT COUNT(*) FROM M_WORK WHERE 1=1 AND TO_CHAR(MW_MONTH,'MM') = LPAD(#{mw_month},2,'0') AND w_except = 'Y' AND w_name != 'SI 사업 발주 대기')/(SELECT COUNT(*) FROM M_WORK WHERE 1=1 AND TO_CHAR(MW_MONTH,'MM') = LPAD(#{mw_month},2,'0') AND w_except = 'Y')*100),1) AS avg1
        FROM m_work
        WHERE 1=1
        AND TO_CHAR(MW_MONTH,'MM') = LPAD(#{mw_month},2,'0')
        AND TO_CHAR(MW_YEAR,'YYYY') = #{mw_year}
  	</select>
  	
  	<select id="monthlyList" parameterType="MonthlyWork" resultType="MonthlyWork">
  		SELECT b.m_id,
  			   b.m_gubun,
  			   b.m_name,
  			   b.m_position,
	           a.w_name,
	           c.l_name,
	           (SELECT a.mw_status	FROM M_WORK A WHERE 1=1 AND A.M_ID = b.m_id  and to_char(a.mw_year,'yyyy') = #{mw_year} and to_char(a.mw_month,'MM') = '01') as JAN,
	           (SELECT a.mw_status	FROM M_WORK A WHERE 1=1 AND A.M_ID = b.m_id  and to_char(a.mw_year,'yyyy') = #{mw_year} and to_char(a.mw_month,'MM') = '02') as FEB,
	           (SELECT a.mw_status	FROM M_WORK A WHERE 1=1 AND A.M_ID = b.m_id  and to_char(a.mw_year,'yyyy') = #{mw_year} and to_char(a.mw_month,'MM') = '03') as MAR,
	           (SELECT a.mw_status	FROM M_WORK A WHERE 1=1 AND A.M_ID = b.m_id  and to_char(a.mw_year,'yyyy') = #{mw_year} and to_char(a.mw_month,'MM') = '04') as APR,
	           (SELECT a.mw_status	FROM M_WORK A WHERE 1=1 AND A.M_ID = b.m_id  and to_char(a.mw_year,'yyyy') = #{mw_year} and to_char(a.mw_month,'MM') = '05') as MAY,
	           (SELECT a.mw_status	FROM M_WORK A WHERE 1=1 AND A.M_ID = b.m_id  and to_char(a.mw_year,'yyyy') = #{mw_year} and to_char(a.mw_month,'MM') = '06') as JUN,
	           (SELECT a.mw_status	FROM M_WORK A WHERE 1=1 AND A.M_ID = b.m_id  and to_char(a.mw_year,'yyyy') = #{mw_year} and to_char(a.mw_month,'MM') = '07') as JUL,
	           (SELECT a.mw_status	FROM M_WORK A WHERE 1=1 AND A.M_ID = b.m_id  and to_char(a.mw_year,'yyyy') = #{mw_year} and to_char(a.mw_month,'MM') = '08') as AUG,
	           (SELECT a.mw_status	FROM M_WORK A WHERE 1=1 AND A.M_ID = b.m_id  and to_char(a.mw_year,'yyyy') = #{mw_year} and to_char(a.mw_month,'MM') = '09') as SEPT,
	           (SELECT a.mw_status	FROM M_WORK A WHERE 1=1 AND A.M_ID = b.m_id  and to_char(a.mw_year,'yyyy') = #{mw_year} and to_char(a.mw_month,'MM') = '10') as OCT,
	           (SELECT a.mw_status	FROM M_WORK A WHERE 1=1 AND A.M_ID = b.m_id  and to_char(a.mw_year,'yyyy') = #{mw_year} and to_char(a.mw_month,'MM') = '11') as NOV,
	           (SELECT a.mw_status	FROM M_WORK A WHERE 1=1 AND A.M_ID = b.m_id  and to_char(a.mw_year,'yyyy') = #{mw_year} and to_char(a.mw_month,'MM') = '12') as DEC,
	           a.mw_notice,
	           TO_CHAR(a.mw_year,'yyyy') AS mw_year,
	           TO_CHAR(a.mw_month,'MM') AS mw_month
  		FROM M_WORK A, member B, site c
        WHERE 1=1
        AND A.M_ID = b.m_id
        AND A.L_CODE = c.L_CODE
        and to_char(a.mw_year,'yyyy') = #{mw_year}
        and to_char(a.mw_month,'MM') = LPAD(#{mw_month},2,'0')
        <if test="m_gubun != 'G0'"> and B.m_gubun = #{m_gubun}</if>
        <if test="m_name != '전체'">and B.m_name like '%'||#{m_name}||'%'</if>
        <if test="m_position != '전체'">AND B.m_position = #{m_position}</if>
        <if test="w_name != '전체'">AND A.w_name = #{w_name}</if>
  	</select>
  	
  	<select id="monthlyDetail" parameterType="MonthlyWork" resultType="MonthlyWork">
  		select a.m_gubun,
             a.d_code,
             a.m_name,
             a.m_position,
             a.m_notice,
             b.mw_month,
             b.w_name,
             b.w_except,
             b.mw_notice
	      from MEMBER A, M_WORK B
	      where 1=1
	      and a.m_id=b.m_id
	      and a.m_name = #{m_name}
	      and to_char(b.mw_year,'yyyy') = to_char(sysdate,'yyyy')
	      and to_char(b.mw_month,'MM') > (TO_CHAR(SYSDATE,'MM')-12)
	      order by b.mw_year,b.mw_month
  	</select>
  	
  	<select id="monthlyStatusInput" parameterType="MonthlyWork" resultType="MonthlyWork">
  		SELECT b.m_id,
  			   b.m_gubun,
  			   b.m_name,
  			   b.m_position,
	           a.w_name,
	           c.l_name,
	           (SELECT a.mw_status	FROM M_WORK A WHERE 1=1 AND A.M_ID = b.m_id  and to_char(a.mw_year,'yyyy') = #{mw_year} and to_char(a.mw_month,'MM') = '01') as JAN,
	           (SELECT a.mw_status	FROM M_WORK A WHERE 1=1 AND A.M_ID = b.m_id  and to_char(a.mw_year,'yyyy') = #{mw_year} and to_char(a.mw_month,'MM') = '02') as FEB,
	           (SELECT a.mw_status	FROM M_WORK A WHERE 1=1 AND A.M_ID = b.m_id  and to_char(a.mw_year,'yyyy') = #{mw_year} and to_char(a.mw_month,'MM') = '03') as MAR,
	           (SELECT a.mw_status	FROM M_WORK A WHERE 1=1 AND A.M_ID = b.m_id  and to_char(a.mw_year,'yyyy') = #{mw_year} and to_char(a.mw_month,'MM') = '04') as APR,
	           (SELECT a.mw_status	FROM M_WORK A WHERE 1=1 AND A.M_ID = b.m_id  and to_char(a.mw_year,'yyyy') = #{mw_year} and to_char(a.mw_month,'MM') = '05') as MAY,
	           (SELECT a.mw_status	FROM M_WORK A WHERE 1=1 AND A.M_ID = b.m_id  and to_char(a.mw_year,'yyyy') = #{mw_year} and to_char(a.mw_month,'MM') = '06') as JUN,
	           (SELECT a.mw_status	FROM M_WORK A WHERE 1=1 AND A.M_ID = b.m_id  and to_char(a.mw_year,'yyyy') = #{mw_year} and to_char(a.mw_month,'MM') = '07') as JUL,
	           (SELECT a.mw_status	FROM M_WORK A WHERE 1=1 AND A.M_ID = b.m_id  and to_char(a.mw_year,'yyyy') = #{mw_year} and to_char(a.mw_month,'MM') = '08') as AUG,
	           (SELECT a.mw_status	FROM M_WORK A WHERE 1=1 AND A.M_ID = b.m_id  and to_char(a.mw_year,'yyyy') = #{mw_year} and to_char(a.mw_month,'MM') = '09') as SEPT,
	           (SELECT a.mw_status	FROM M_WORK A WHERE 1=1 AND A.M_ID = b.m_id  and to_char(a.mw_year,'yyyy') = #{mw_year} and to_char(a.mw_month,'MM') = '10') as OCT,
	           (SELECT a.mw_status	FROM M_WORK A WHERE 1=1 AND A.M_ID = b.m_id  and to_char(a.mw_year,'yyyy') = #{mw_year} and to_char(a.mw_month,'MM') = '11') as NOV,
	           (SELECT a.mw_status	FROM M_WORK A WHERE 1=1 AND A.M_ID = b.m_id  and to_char(a.mw_year,'yyyy') = #{mw_year} and to_char(a.mw_month,'MM') = '12') as DEC,
	           a.mw_notice
  		FROM M_WORK A, member B, site c
        WHERE 1=1
        AND A.M_ID = b.m_id
        AND A.L_CODE = c.L_CODE
        and to_char(a.mw_year,'yyyy') = #{mw_year}
        and to_char(a.mw_month,'MM') = LPAD(#{mw_month},2,'0')
        and B.m_gubun = #{m_gubun}
        and B.m_name = #{m_name}
        AND B.m_position = #{m_position}
        AND A.w_name = #{w_name}
  	</select>
  </mapper>